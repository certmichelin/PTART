{% extends "base.html" %}

{% block title %} {{ sh0t.title }} | sh00t{% endblock %}

{% block extra_head %}
<link href="/static/css/screenshots.css" rel="stylesheet" type="text/css">
<link href="/static/sb-admin/css/plugins/fancybox/jquery.fancybox.min.css"" rel=" stylesheet" type="text/css">

{% endblock %}

{% block page %}
<div id="page-wrapper">
    <div class="container-fluid">

        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">Sh0t</h1>
                <ol class="breadcrumb">
                    <li><i class="fa fa-dashboard"></i> <a href="/">Dashboard</a></li>
                    <li><i class="fa fa-bullseye"></i> <a href="/app/sh0ts">Sh0t</a></li>
                    <li class="active">{{ sh0t.title }} <span id="response" class="small"></span></li>
                </ol>
            </div>
        </div>

        {% include "_include/messages-container.html" %}

        <div class="row">
            <div class="col-lg-8">
                <div class="form-group">
                    <label>Severity</label>
                    <select id="severity" class="form-control">
                        {% for sev in severities %}
                        <option value={{sev}}> P{{sev}} </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input id="title" class="form-control" value="{{ sh0t.title }}" autocomplete="off" />
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <textarea id="body" class="form-control" rows="10">{{ sh0t.body }}</textarea>
                </div>
                <div class="form-group">
                    <label for="assessment">Assessment</label>
                    <select id="assessment" class="form-control">
                        {% for assessment in assessments %}
                        <option value="{{ assessment.id }}" {% if assessment.id == sh0t.assessment.id %}
                            selected="selected" {% endif %}>{{ assessment.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input id="id" type="hidden" value="{{ sh0t.id }}" />
                <button id="updateBtn" class="btn btn-primary">Update</button>
                <button id="delBtn" class="btn btn-danger">Delete</button>
            </div>
            <div class="col-lg-4">
                {% include "_include/screenshots-container.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_foot %}
<script src="/static/sb-admin/js/plugins/fancybox/jquery.fancybox.min.js"></script>
<script src="/static/js/screenshots.js"></script>
<script type="text/javascript">

    /* Select the current severity */$
    $('#severity option[value={{sh0t.severity}}]').attr('selected', 'selected');

    /**
     * Update sh0t.
     */
    $('#updateBtn').on('click', function () {
        cleanMessagesContainer($("#messages"));
        ajaxUpdateSh0t(sh0tUpdateSuccess, commonFailure, $("#id").val(), $("#severity").val(), $("#title").val(), $("#body").val(), $("#assessment").val());
    });

    /**
     * Sh0t update success callback.
     */
    function sh0tUpdateSuccess(data) {
        success($("#messages"), "Sh0t was updated!");
    }

    /**
    * Sh0t deletion success callback.
    */
    function sh0tDeletionSuccess(data) {
        success($("#messages"), "Sh0t was deleted! You will redirect in 2s!");
        setTimeout(function () {
            history.go(-1);
        }, 2000);
    }

    /**
     * Sh0t deletion failure callback.
     */
    function sh0tDeletionFailure(data) {
        error($("#messages"), "Sh0t was not found");
    }

    /**
     * Delete sh0t.
     */
    $('#delBtn').on('click', function () {
        bootbox.confirm({
            message: "Are you sure to delete the sh0t?",
            buttons: {
                confirm: {
                    label: 'Yes',
                    className: 'btn-success'
                },
                cancel: {
                    label: 'No',
                    className: 'btn-danger'
                }
            },
            callback: function (result) {
                if (result) {
                    cleanMessagesContainer($("#messages"));
                    ajaxDeleteSh0t(sh0tDeletionSuccess, sh0tDeletionFailure, $("#id").val());
                }
            }
        });
    });

    /**
     * Override addScreenshot from screenshot.js in order to upload the file on the fly.
     */
    function addScreenshot() {
        var dataURL = $("#screenshotData").val()
        if (dataURL !== "") {
            ajaxUploadScreenshot(screenshotCreationSuccess, commonFailure, dataURL, $("#id").val());
        } else {
            bootbox.alert("No screenshot is pasted!")
        }
    }

    /**
     * Override drop from screenshot.js in order to delete the file on the fly.
     */
    function drop(ev) {
        ev.preventDefault();
        id = ev.dataTransfer.getData("text");
        ajaxDeleteScreenshot(screenshotDeletionSuccess, commonFailure, id.replace("screenshot_", ""));
    }

    /**
     * Screenshot creation success callback.
     */
    function screenshotCreationSuccess(data) {
        createScreenshot(data.id, "/api/screenshot/png/" + data.id + "/")
        resetScreenshotModal();
    }

    /**
     * Screenshot deletion success callback.
     */
    function screenshotDeletionSuccess(data) {
        removeScreenshot("screenshot_" + data.id);
    }
</script>
{% endblock %}