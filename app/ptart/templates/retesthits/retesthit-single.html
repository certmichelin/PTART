{% extends "base.html" %}
{% block title %} {{ retesthit.retest_campaign.name }} | PTART{% endblock %}
{% load addstr static %}

{% block page %}
<div id="page-wrapper">
    <div class="container-fluid">

        {% include '_include/html/header.html' with item='' sub_icon='fa fa-cubes' sub_url="/project/"|addstr:retesthit.retest_campaign.project.pk|addstr:"/summary" sub_text=retesthit.retest_campaign.project third_icon='fa fa-flask' third_url="/retestcampaign/"|addstr:retesthit.retest_campaign.pk|addstr:"/summary" third_text=retesthit.retest_campaign active_icon='' active_text=retesthit.hit.title %}
        {% include "_include/html/messages.html" %}

        <div class="row min-vh-100">
            <iframe class="col-lg-6" src="/hit/{{ retesthit.hit.id }}?embedded=True" style="border: none;"></iframe>
            <div class="col-lg-6">
                <h5>Retest</h5>

                <div class="form-group">
                    <label>Status</label>
                    <select id="status" class="form-control">
                        <option value="NT">Not Tested</option>
                        <option value="NA">Not Applicable</option>
                        <option value="NF">Not Fixed</option>
                        <option value="PF">Partially Fixed</option>
                        <option value="F">Fixed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Body</label>
                    <textarea class="form-control" rows="5" id="body" style="resize:vertical">{{ retesthit.body }}</textarea>
                </div>

                <!-- Secure preview (Markdown + Mermaid) -->
                <div class="form-group">
                    <label>Rendered Body Preview</label>
                    <div class="markdown-body" id="retest-body-preview"></div>
                </div>

                <input id="id" type="hidden" value="{{ retesthit.id }}" />
                <input id="campaignId" type="hidden" value="{{ retesthit.retest_campaign.id }}" />
                <input id="hitId" type="hidden" value="{{ retesthit.hit.id }}" />

                {% if editable == True %}
                <button id="updateBtn" class="btn btn-outline-primary mb-3">Update</button>
                <button id="delBtn" class="btn btn-outline-danger mb-3">Delete</button>
                {% endif %}

                {% include "_include/html/screenshots.html" %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_foot %}
{% include '_include/js/deleteItem.html' with item='RetestHit' ajax_function='ajaxDeleteRetestHit' redirect="/retestcampaign/"|addstr:retesthit.retest_campaign.id|addstr:"/summary" %}

<style>
  .mermaid-error {
    background: #2b2b2b;
    color: #ffdddd;
    padding: 10px;
    border-radius: 6px;
    white-space: pre-wrap;
  }
</style>

<script>
    activeMarkdown("body");
    $('#status option[value={{retesthit.status}}]').attr('selected', 'selected');

    /**
     * Retest Hit updation success callback.
     */
     function retestHitUpdationSuccess(data) {
        success($("#messages"), "Retest Hit was Updated!");
    }

    /**
     * Update item.
     */
    $('#updateBtn').on('click', function () {
        cleanMessagesContainer($("#messages"));
        ajaxUpdateRetestHit(retestHitUpdationSuccess, commonFailure, $("#id").val(), $("#body").val(), $("#status").val(), $("#hitId").val(), $('#campaignId').val());
    });

    activeBootstapMenuForScreenshots(screenshotMoveUpCallback,screenshotMoveDownCallback);

    /* --------------------------------------------------------------------------------------------------- */
    /* --------------------------------------- Screenshots Actions --------------------------------------- */
    /* --------------------------------------------------------------------------------------------------- */
    apiRoute = "/api/retestscreenshot/png/";

    /**
     * Override addScreenshot from screenshot.js in order to upload the file on the fly.
     */
     function addScreenshot() {
        var dataURL = $("#screenshotData").val()
        var caption = $("#screenshotCaption").val()
        if (dataURL !== "") {
            ajaxUploadRetestScreenshot(screenshotCreationSuccess, commonFailure, dataURL, caption, $("#id").val());
        } else {
            bootbox.alert("No screenshot is pasted!")
        }
    }

    /**
     * Override dropDeleteScreenshot from screenshot.js in order to delete the file on the fly.
     */
    function dropDeleteScreenshot(ev) {
        ev.preventDefault();
        id = convertMarkdownToId(ev.dataTransfer.getData("text"));
        ajaxDeleteRetestScreenshot(screenshotDeletionSuccess, commonFailure, id);
    }

    /**
     * Screenshot creation success callback.
     */
    function screenshotCreationSuccess(data) {
        createScreenshot(data.id, "/api/retestscreenshot/png/" + data.id + "/", data.caption, data.order);
        buildContextMenuForScreenshots("screenshot_link_" + data.id, data.id, data.order, $('.screenshot').length, screenshotMoveUpCallback,screenshotMoveDownCallback);
        var previousBlock = $("#screenshot_link_" + data.id).prev('.screenshot');
        if (previousBlock.length) {
            previousBlock.contextMenu('destroy');
            buildContextMenuForScreenshots(previousBlock.attr('id'),previousBlock.attr('data-screenshot-id'),parseInt(previousBlock.attr('data-screenshot-order'), 10), $('.screenshot').length ,screenshotMoveUpCallback,screenshotMoveDownCallback);
        }
        resetScreenshotModal();
    }

    /**
     * Screenshot deletion success callback.
     */
    function screenshotDeletionSuccess(data) {
        removeScreenshot(data.id);
        //Apply reordering on UI.
        var count = $('.screenshot').length;

        $(".screenshot").each(function() {
            var order = parseInt($(this).attr('data-screenshot-order'),10)
            if ( order > data.order) {
                var newOrder = order - 1;
                $(this).attr('data-screenshot-order', newOrder);

                //Rebuild context menu.
                $(this).contextMenu('destroy');
                buildContextMenuForScreenshots($(this).attr('id'),$(this).attr('data-screenshot-id'),newOrder,count,screenshotMoveUpCallback,screenshotMoveDownCallback);
            } else if (order == (data.order - 1)) {
                $(this).contextMenu('destroy');
                buildContextMenuForScreenshots($(this).attr('id'),$(this).attr('data-screenshot-id'),order,count,screenshotMoveUpCallback,screenshotMoveDownCallback);
            }
        });
    }

    /**
     * Callback to take in account reordering of screenshots.
     */
    function screenshotMoveUpSuccess(data) {
        var currentBlockId = "screenshot_link_" + data.id;
        var currentBlock = $("#" + currentBlockId);
        var previousBlock = currentBlock.prev('.screenshot');

        //Change data-order attribute for both elements.
        currentBlock.attr('data-screenshot-order', data.order);
        previousBlock.attr('data-screenshot-order', data.order + 1);

        //Change the order in the DOM.
        moveUpScreenshot(currentBlockId);

        //Update Context menu.
        currentBlock.contextMenu('destroy');
        previousBlock.contextMenu('destroy');

        var count = $('.screenshot').length;
        buildContextMenuForScreenshots(currentBlock.attr('id'),currentBlock.attr('data-screenshot-id'),parseInt(currentBlock.attr('data-screenshot-order'), 10),count,screenshotMoveUpCallback,screenshotMoveDownCallback);
        buildContextMenuForScreenshots(previousBlock.attr('id'),previousBlock.attr('data-screenshot-id'),parseInt(previousBlock.attr('data-screenshot-order'), 10),count,screenshotMoveUpCallback,screenshotMoveDownCallback);
    }

    /**
     * Callback to take in account reordering of screenshots.
     */
     function screenshotMoveDownSuccess(data) {
        var currentBlockId = "screenshot_link_" + data.id;
        var currentBlock = $("#" + currentBlockId);
        var nextBlock = currentBlock.next('.screenshot');

        //Change data-order attribute for both elements.
        currentBlock.attr('data-screenshot-order', data.order);
        nextBlock.attr('data-screenshot-order', data.order - 1);

        //Change the order in the DOM.
        moveDownScreenshot(currentBlockId);

        //Update Context menu.
        currentBlock.contextMenu('destroy');
        nextBlock.contextMenu('destroy');

        var count = $('.screenshot').length;
        buildContextMenuForScreenshots(currentBlock.attr('id'),currentBlock.attr('data-screenshot-id'),parseInt(currentBlock.attr('data-screenshot-order'), 10),count, screenshotMoveUpCallback,screenshotMoveDownCallback);
        buildContextMenuForScreenshots(nextBlock.attr('id'),nextBlock.attr('data-screenshot-id'),parseInt(nextBlock.attr('data-screenshot-order'), 10),count,screenshotMoveUpCallback,screenshotMoveDownCallback);
    }

    function screenshotMoveUpCallback(screenshotBlockId, screenshotId, order) {
        ajaxReorderRetestScreenshot(screenshotMoveUpSuccess, commonFailure, screenshotId, order);
    }

    function screenshotMoveDownCallback(screenshotBlockId, screenshotId, order) {
        ajaxReorderRetestScreenshot(screenshotMoveDownSuccess, commonFailure, screenshotId, order);
    }
</script>

<script src="{% static 'js/plugins/marked/marked.min.js' %}"></script>
<script src="{% static 'js/plugins/dompurify/purify.min.js' %}"></script>
<script src="{% static 'js/plugins/mermaid/mermaid.min.js' %}"></script>

<script>
  // --------------------------------------------------
  // Mermaid init
  // --------------------------------------------------
  mermaid.initialize({
    startOnLoad: false,
    securityLevel: "strict",
    htmlLabels: false
  });

  function sanitizeMarkdownToHtml(rawText) {
    const unsafeHtml = marked.parse(rawText ?? "");
    return DOMPurify.sanitize(unsafeHtml, {
      USE_PROFILES: { html: true },
      FORBID_TAGS: ["style", "script", "iframe", "object", "embed"],
      FORBID_ATTR: ["onerror", "onload", "onclick", "onmouseover"]
    });
  }

  function uid() {
    return "mmd_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }

  function convertMermaidCodeBlocks(container) {
    const codeBlocks = container.querySelectorAll("pre > code.language-mermaid, pre > code.lang-mermaid");
    codeBlocks.forEach((codeEl) => {
      const pre = codeEl.parentElement;
      const mermaidDiv = document.createElement("div");
      mermaidDiv.className = "mermaid";
      mermaidDiv.textContent = codeEl.textContent || "";
      if (!mermaidDiv.id) mermaidDiv.id = uid();
      pre.replaceWith(mermaidDiv);
    });
  }

  function renderMermaidInside(targetEl) {
    const mermaidNodes = targetEl.querySelectorAll(".mermaid");
    mermaidNodes.forEach((node) => {
      if (node.getAttribute("data-mmd-rendered") === "true") return;

      const src = (node.textContent || "").trim();
      if (!src) return;

      if (!node.id) node.id = uid();

      try {
        mermaid.parse(src);
        mermaid.run({ nodes: [node] }).then(() => {
          node.setAttribute("data-mmd-rendered", "true");
        }).catch((e) => {
          const err = document.createElement("pre");
          err.className = "mermaid-error";
          err.textContent = "Mermaid diagram error:\n" + (e?.message || String(e));
          node.replaceWith(err);
        });
      } catch (e) {
        const err = document.createElement("pre");
        err.className = "mermaid-error";
        err.textContent = "Mermaid diagram error:\n" + (e?.message || String(e));
        node.replaceWith(err);
      }
    });
  }

  function renderMarkdownWithMermaid(rawText, targetEl) {
    if (!targetEl) return;

    const hash = String(rawText ?? "");
    if (targetEl.getAttribute("data-md-hash") === hash) {
      renderMermaidInside(targetEl);
      return;
    }

    targetEl.innerHTML = sanitizeMarkdownToHtml(rawText);
    convertMermaidCodeBlocks(targetEl);
    renderMermaidInside(targetEl);

    targetEl.setAttribute("data-md-hash", hash);
  }

  function refreshRetestPreview() {
    renderMarkdownWithMermaid(
      document.getElementById("body")?.value,
      document.getElementById("retest-body-preview")
    );
  }

  window.addEventListener("DOMContentLoaded", function () {
    refreshRetestPreview();

    const debouncedRefresh = (() => {
      let t;
      return () => {
        clearTimeout(t);
        t = setTimeout(refreshRetestPreview, 250);
      };
    })();

    const el = document.getElementById("body");
    if (el) el.addEventListener("input", debouncedRefresh);
  });
</script>

{% endblock %}
